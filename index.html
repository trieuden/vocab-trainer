<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Luy·ªán T·ª´ V·ª±ng</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-neutral-800 text-white text-center p-5 min-h-screen box-border font-sans">
        <div class="bg-neutral-700 rounded-xl p-6 max-w-md mx-auto shadow-lg relative w-full">
            <p id="tagname" class="absolute top-[2px] right-[5px] text-xs">@trieuden</p>

            <h2 id="word" class="text-2xl font-bold mb-5 break-words">...</h2>

            <input type="text" id="answer" placeholder="Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát" onkeydown="handleKey(event)" class="p-3 w-full text-base border border-gray-300 rounded mb-4 text-black" />

            <div class="mb-3">
                <button onclick="checkAnswer()" class="bg-green-600 text-white py-3 px-4 rounded text-sm m-1 min-h-[44px]">Ki·ªÉm tra</button>
                <button onclick="showResult()" class="bg-blue-600 text-white py-3 px-4 rounded text-sm m-1 min-h-[44px]">Hi·ªán k·∫øt qu·∫£</button>
            </div>

            <div class="mb-3">
                <button onclick="speakWord()" class="bg-orange-500 text-white py-3 px-4 rounded text-sm m-1 min-h-[44px]">üîä Ph√°t √¢m</button>
                <button id="voiceBtn" onclick="toggleVoiceRecognition()" class="bg-purple-700 text-white py-3 px-4 rounded text-sm m-1 min-h-[44px]">üé§ N√≥i</button>
            </div>

            <div class="mb-3 flex items-center justify-center">
                <input class="size-4 mr-1" type="checkbox" id="advanceToggle" />
                <span>Advance</span>
            </div>

            <div id="result" class="mt-2 font-bold text-red-600"></div>
            <div class="mt-6 text-gray-300 text-base">ƒê√∫ng: <span id="correctCount" class="text-green-400 font-bold">0</span> | Sai: <span id="wrongCount" class="text-red-400 font-bold">0</span></div>

            <div class="mt-3">
                <label for="fileInput" class="border border-dotted text-white py-2 px-4 rounded cursor-pointer inline-block">Import</label>
                <input type="file" id="fileInput" accept=".txt" class="hidden" />
                <div id="fileNameDisplay" class="text-sm text-gray-400 mt-2">Ch∆∞a ch·ªçn file</div>
            </div>
        </div>

        <script>
            let data = {};
            let keys = [];
            let currentWord = "";
            let correctCount = 0;
            let wrongCount = 0;
            let isRecording = false;
            let recognition = null;
            let showVoc = false;
            let isReverse = false;

            const fileInput = document.getElementById("fileInput");
            const fileNameDisplay = document.getElementById("fileNameDisplay");
            const advanceToggle = document.getElementById("advanceToggle");

            advanceToggle.addEventListener("change", () => {
                isReverse = advanceToggle.checked;
                pickRandomWord();
            });

            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    readFile(file);
                }
            });

            function normalize(text) {
                return text
                    .replace(/\([^)]*\)/g, "") // x√≥a (adj), (n), (v), ...
                    .replace(/\/[^/]*\//g, "") // x√≥a /ph√°t √¢m/
                    .replace(/\s+/g, " ") // lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞
                    .trim()
                    .toLowerCase();
            }

            function readFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split("\n");
                    data = {};
                    lines.forEach((line) => {
                        const [key, value] = line.split(":");
                        if (key && value) data[key.trim()] = value.trim();
                    });
                    keys = Object.keys(data);
                    if (keys.length > 0) pickRandomWord();
                    else alert("File kh√¥ng h·ª£p l·ªá. ƒê·ªãnh d·∫°ng: t·ª´: nghƒ©a");
                };
                reader.readAsText(file);
            }

            if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = "vi-VN";
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = function (event) {
                    let transcript = event.results[0][0].transcript;
                    transcript = transcript.replace(/\.$/, "");
                    document.getElementById("answer").value = transcript;
                    stopRecording();
                };

                recognition.onerror = recognition.onend = () => stopRecording();
            }

            fetch("vocabulary_list.txt")
                .then((res) => res.text())
                .then((text) => {
                    const lines = text.split("\n");
                    lines.forEach((line) => {
                        const [key, value] = line.split(":");
                        if (key && value) data[key.trim()] = value.trim();
                    });
                    keys = Object.keys(data);
                    pickRandomWord();
                });

            function pickRandomWord() {
                currentWord = keys[Math.floor(Math.random() * keys.length)];
                const displayWord = isReverse ? data[currentWord].split("/")[0] : currentWord;
                document.getElementById("word").textContent = displayWord;
                document.getElementById("answer").value = "";
                document.getElementById("result").textContent = "";
            }

            function handleKey(event) {
                if (event.key === "Enter") checkAnswer();
                else if (event.key === "Shift") showResult();
                else if (event.key === " " && event.ctrlKey) {
                    event.preventDefault();
                    speakWord();
                } else if (event.key === " " && event.altKey) {
                    event.preventDefault();
                    toggleVoiceRecognition();
                }
            }

            function checkAnswer() {
                const userInput = normalize(document.getElementById("answer").value);

                let correctAnswers;
                if (isReverse) {
                    correctAnswers = normalize(currentWord);
                    if (userInput === correctAnswers) {
                        if (!showVoc) correctCount++;
                        showVoc = false;
                        updateStats();
                        pickRandomWord();
                    } else {
                        wrongCount++;
                        updateStats();
                        document.getElementById("result").textContent = "Sai r·ªìi! B·ªõt ngu l·∫°i con ch√≥.";
                    }
                } else {
                    correctAnswers = data[currentWord]
                        .toLowerCase()
                        .split("/")
                        .map((x) => normalize(x));

                    if (correctAnswers.includes(userInput)) {
                        if (!showVoc) correctCount++;
                        showVoc = false;
                        updateStats();
                        pickRandomWord();
                    } else {
                        wrongCount++;
                        updateStats();
                        document.getElementById("result").textContent = "Sai r·ªìi! B·ªõt ngu l·∫°i con ch√≥.";
                    }
                }
            }

            function showResult() {
                if (!showVoc) wrongCount++;
                showVoc = true;

                if (isReverse) {
                    document.getElementById("answer").value = normalize(currentWord);
                    document.getElementById("result").textContent = `T·ª´ ƒë√∫ng l√†: "${normalize(currentWord)}"`;
                } else {
                    const meaning = data[currentWord].split("/")[0];
                    document.getElementById("answer").value = meaning;
                    document.getElementById("result").textContent = `Nh·ªõ kƒ© cho tao: "${data[currentWord]}"`;
                }

                updateStats();
            }

            function updateStats() {
                document.getElementById("correctCount").textContent = correctCount;
                document.getElementById("wrongCount").textContent = wrongCount;
            }

            function speakWord() {
                if ("speechSynthesis" in window) {
                    const textToSpeak = isReverse ? data[currentWord].split("/")[0] : currentWord;
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = isReverse ? "vi-VN" : "en-US";
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                } else {
                    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m.");
                }
            }

            function toggleVoiceRecognition() {
                if (!recognition) {
                    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.");
                    return;
                }
                isRecording ? stopRecording() : startRecording();
            }

            function startRecording() {
                isRecording = true;
                const voiceBtn = document.getElementById("voiceBtn");
                voiceBtn.classList.add("bg-red-600", "animate-pulse");
                voiceBtn.textContent = "üî¥ ƒêang nghe...";
                recognition.start();
            }

            function stopRecording() {
                isRecording = false;
                const voiceBtn = document.getElementById("voiceBtn");
                voiceBtn.classList.remove("bg-red-600", "animate-pulse");
                voiceBtn.textContent = "üé§ N√≥i";
                recognition.stop();
            }
        </script>
    </body>
</html>
